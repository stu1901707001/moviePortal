<!DOCTYPE html>
<html lang="en">
<head>
    <title>Movie App</title>

    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">

    
</head>
<body>
	<div class="home-page">
        <header>
            <div class="container">
                 <div class="row">
                        <!-- Collect the nav links, forms, and other content for toggling -->
                         
                            <div class="col-3 m-3">
                                    <a href="home.html">
                                        <h4 class="nav-label text-light">Home</h4>
                                    </a>
                                </div>
                                 <div class="col-3 m-3">
                                    <a href="genres.html">
                                        <h4 class="nav-label text-light">Genres</h4>
                                    </a>
                                </div>
                                 <div class="col-3 m-3">
                                    <a href="profile.html">
                                        <h3 class="nav-label text-light">Profile</h3>
                                    </a>
                                </div>
                                 <div class="col-3 m-3">
                                    <a href="#" id="logout">
                                        <h4 class="nav-label text-light">Logout</h4>
                                    </a>
                                </div>                            
                         <!-- /.navbar-collapse -->
                </div>
            </div>
        </header>       
	</div>
	<div id="gridView" class="container-fluid">
        <div class="row filter-wrapper m-3">
            <div class="col-md-4">
                <label for="filter-year">Year</label>
                <select class="custom-select" id="filter-year">
                    <option selected disabled value="">Choose...</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                    <option value="2014">2014</option>
                    <option value="2013">2013</option>
                    <option value="2012">2012</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="genre">Genre</label>
                <select class="custom-select" id="filter-genre">
                    <option selected disabled value="">Choose ...</option>
                    <option value="28">Action</option>
                    <option value="12">Adventure</option>
                    <option value="16">Animation</option>
                    <option value="35">Comedy</option>
                    <option value="80">Crime</option>
                    <option value="99">Documentary</option>
                    <option value="18">Drama</option>
                    <option value="14">Fantasy</option>
                    <option value="36">History</option>
                    <option value="27">Horror</option>
                </select>
            </div>
            <!-- <div class="col-md-8">
                <div class="row" id="genres">
                    <div class="col-md-4">
                        <input type="checkbox" id="action" name="action" value="28">
                        <label for="action">Action</label><br>
                        <input type="checkbox" id="adventure" name="adventure" value="12">
                        <label for="adventure">Adventure</label><br>
                        <input type="checkbox" id="animation" name="animation" value="16">
                        <label for="animation">Animation</label><br>
                        <input type="checkbox" id="comedy" name="comedy" value="35">
                        <label for="comedy">Comedy</label><br>
                        <input type="checkbox" id="crime" name="crime" value="80">
                        <label for="crime">Crime</label><br>
                        <input type="checkbox" id="documentary" name="documentary" value="99">
                        <label for="documentary">Documentary</label><br>
                        <input type="checkbox" id="drama" name="drama" value="18">
                        <label for="drama">Drama</label><br>
                    </div>
                    <div class="col-md-4">
                        <input type="checkbox" id="family" name="family" value="10751">
                        <label for="family">Family</label><br>
                        <input type="checkbox" id="fantasy" name="fantasy" value="14">
                        <label for="fantasy">Fantasy</label><br>
                        <input type="checkbox" id="history" name="history" value="36">
                        <label for="history">History</label><br>
                        <input type="checkbox" id="horror" name="horror" value="27">
                        <label for="horror">Horror</label><br>
                        <input type="checkbox" id="music" name="music" value="10402">
                        <label for="music">Music</label><br>
                        <input type="checkbox" id="mystery" name="mystery" value="9648">
                        <label for="mystery">Mystery</label><br>
                        <input type="checkbox" id="romance" name="romance" value="10749">
                        <label for="romance">Romance</label><br>
                    </div>
                    <div class="col-md-4">
                        <input type="checkbox" id="scienceFiction" name="scienceFiction" value="878">
                        <label for="scienceFiction">Science Fiction</label><br>
                        <input type="checkbox" id="tvMovie" name="tvMovie" value="10770">
                        <label for="tvMovie">TV Movie</label><br>
                        <input type="checkbox" id="thriller" name="thriller" value="53">
                        <label for="thriller">Thriller</label><br>
                        <input type="checkbox" id="war" name="war" value="10752">
                        <label for="war">War</label><br>
                        <input type="checkbox" id="western" name="western" value="37">
                        <label for="western">Western</label><br>
                    </div>
                </div>
            </div> -->
            <div class="col-md-4">
            	<button id="applyFilter" type="button" class="btn btn-dark float-right mb-3">Apply filter</button>
        	</div>
        </div>
        <div class="row m-3">             
            <div class="col-md-4">
            	<label for="sort-by">Sort by</label>
                <select id="sort-by" name="sort-by" class="custom-select d-3" onchange="sortByOnChange(this)">
                    <option selected disabled value="">Choose...</option>
                    <option value="popularity.desc">Popularity Descending</option>
                    <option value="popularity.asc">Popularity Ascending</option>
                    <option value="vote_average.desc" selected="selected">Rating Descending</option>
                    <option value="vote_average.asc">Rating Ascending</option>
                    <option value="release_date.desc">Release Date Descending</option>
                    <option value="release_date.asc">Release Date Ascending</option>
                    <option value="title.asc">Title (A-Z)</option>
                    <option value="title.desc">Title (Z-A)</option>
                </select>
            </div>

            <div class="col-md-4">
                <button id="toggle-gridview" type="button" class="btn btn-primary mb-3">Toggle grid view</button>
            </div>
        </div>
        <div class="row d-flex m-3" id="movies-list"></div>
        <div id="movie-template" style="display:none;" class="col-3">
            <div class="image-wrapper">
                <a class="image" href="#" title="">
                    <img class="" alt="" src="">
                </a>
            </div>
            <div class="text-wrapper">
                <h2></h2>
                <div class="m-2"><span></span></div>
                <p></p>
            </div>
             <div class="btn-wrapper">
            	<button id="editMovieBtn"" type="button" class="btn btn-danger">
            	 Edit
            	 </button>
            	<button id="deleteMovieBtn" type="button" class="btn btn-danger pull-right remove-post">
            	 Delete
            	 </button>
        	</div>
        </div>
        <div class="col-md-4">
         <button id="addMovie" type="button" class="btn btn-dark float-right mb-3">Add movie</button>
    	</div>
    </div>    
    <div class="container">         
        <div class="row" id="movie-form-container" style="display: none;">             
            <div class="col-md-5">
                <form class="basic-panel" id="movie-form" action="movie/save" method="POST">                    
                    <div class="form-group">
                        <label for="title">Title</label>
                        <div class="input-group">                             
                            <input type="text" class="form-control" id="title" name="title" placeholder="title">
                        </div>  
                        <p class="help-block">Полето "Title" е празно</p>                       
                    </div>
                     <div class="form-group">
                        <label for="image">Image path</label>
                        <div class="input-group">                             
                            <input type="text" class="form-control" id="image" name="image" placeholder="image">
                        </div>                         
                    </div>
                    <div class="form-group">
                        <label for="overview">Overview</label>
                        <div class="input-group">                             
                            <input type="text" class="form-control" id="overview" name="overview" placeholder="overview">
                        </div>                         
                    </div>
                    <div class="form-group">
                        <label for="title">Popularity</label>
                        <div class="input-group">                             
                            <input type="number" class="form-control" id="popularity" name="popularity" placeholder="popularity">
                        </div>                         
                    </div>
                    <div class="form-group">
                        <label for="title">Vote average</label>
                        <div class="input-group">                             
                            <input type="number" class="form-control" id="vote_average" name="vote_average" placeholder="vote_average">
                        </div>                         
                    </div>
                    <div class="form-group">
                        <label for="title">Release Date</label>
                        <div class="input-group">                             
                            <input type="date" class="form-control" id="releaseDate" name="releaseDate" placeholder="releaseDate">
                        </div>                         
                    </div>
                    <div class="form-group">
                    <label for="genre">Genre</label>
		                <select class="custom-select" id="genre_id" name="genre_id">
		                    <option selected disabled value="">Choose ...</option>
		                    <option value="28">Action</option>
		                    <option value="12">Adventure</option>
		                    <option value="16">Animation</option>
		                    <option value="35">Comedy</option>
		                    <option value="80">Crime</option>
		                    <option value="99">Documentary</option>
		                    <option value="18">Drama</option>
		                    <option value="14">Fantasy</option>
		                    <option value="36">History</option>
		                    <option value="27">Horror</option>
		                </select>
		            </div>
                    <input type="hidden" id="editMovieId" name="id" value="0">
                    <button id="submit" type="submit" class="btn btn-primary">Save</button>
                    <button id="cancelMovie" type="submit" class="btn btn-primary pull-right">Cancel</button>
                    
                    </form>
            </div>
        </div>
    </div> 
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
   
    <script src="js/main.js"></script>
    <script>
    var me;
    $(document).ready(function(){
    	function getWhoAmI(){
    		$.ajax({
    			url : "/whoAmI",
    			method : "GET",
    			complete : function(data){ 	
    				console.log("whoAmi");
    				console.log(data);
    				switch(data.status){    				
    				case 200:
    					me = data.responseJSON;
    					console.log(me);
    					break;
    				case 401 :
    					window.location.href="index.html";
    					break;
    				}  				
    				    				
    			},fail : function(){
    				window.location.href="index.html";
    			}
    		});    		
    	}
    	    	
    	function getAllMovies(){ 
    		$.ajax({
    			url: "/movie/all",
    			method : "GET",
    			success : function(data){
    				moviesList = data;
    				reBuildGrid(data);     				
    			},fail : function (){
    				alert("Movies could not be loaded!");
    			}    		
    		}); 
    	}
        
    	$('#movie-form').submit(function (e){
    		e.preventDefault();    		 
    		let id = $('#editMovieId').val();
    		console.log(id);
    		if(id) save(id);
    		else save(0);    		
    	});
    	
    	function save(id) {
    		$.ajax({
    			url: "movie/save",
    			method: "POST",
    			data: {
    				id:id,
    				title: $('#title').val(),
    				releaseDate: $('#releaseDate').val(),
    				image: $('#image').val(),
    				overview: $('#overview').val(),
    				popularity: $('#popularity').val(),
    				genre_id: $('#genre_id').val(),
    				vote_average: $('#vote_average').val()
    			},
    			success: function(data){
    				console.log(data);
    				if(id === 0) { 
    					console.log(moviesList);
    					if(moviesList.results) moviesList.results.unshift(data);  
    					else moviesList.unshift(data); 
    				}
    				reBuildGrid(moviesList);  
    				$('#movie-form-container').hide();
    				$('#gridView').show();
    				//window.location.href = "home.html";
    			},
    			fail: function(){
    				window.location.href = "error.html";
    			}		
    		});
    	}
        
        $('#addMovie').on('click', function(){
        	$('#editMovieId').val(0);
        	$('#title').val('');			 
    		$('#releaseDate').val('');
    		$('#image').val('');
    		$('#overview').val('');
    		$('#popularity').val('');
    		$('#genre_id').val('');//eq('').prop('selected', true);
    		//$('#genre_id').eq(0).prop('selected', false);
    	    $('#vote_average').val('');  
    	    
        	$('#movie-form-container').show();
        	$('#gridView').hide();
        });
         
        $('#cancelMovie').on('click', function(){
        	$('#movie-form-container').hide();
        	$('#gridView').show();
        });
         
        
		$('#logout').on('click', function(){
			$.ajax({
				url: "logout",
				method: "POST",
				complete : function(data){
					if(data.status == 401){
						alert("ERROR!");
					}
					
					window.location.href = "index.html";
					
				}
			});		
			
		});
        
		getWhoAmI();        
        onInit();
        getAllMovies();
        loadData(2020, "18");
    });

    const apiKey = 'b75cc08cea29ecc3dd19cfd9ece3d7fa';
    const imagePrefix = "http://image.tmdb.org/t/p/w220_and_h330_face";
    let moviesList = new Array();
    
    const toggleGridClass = 'flex-column';
    var largeImagePrefix = 'http://image.tmdb.org/t/p/w440_and_h660_face';
    const sortByList = [{ "value": "popularity.desc", "text": "Popularity Descending" },
    { "value": "popularity.asc", "text": "Popularity Ascending" },
    { "value": "vote_average.desc", "text": "Rating Descending" },
    { "value": "vote_average.asc", "text": "Rating Ascending" },
    { "value": "release_date.desc", "text": "Release Date Descending" },
    { "value": "release_date.asc", "text": "Release Date Ascending" },
    { "value": "title.asc", "text": "Title (A-Z)" },
    { "value": "title.desc", "text": "Title (Z-A)" }];

     
    const loadDataOld = (year, with_genres) => {
        var requestUrl = "https://api.themoviedb.org/3/discover/movie?api_key=" + apiKey;
        if (year) requestUrl += "&year=" + year;
        if (with_genres) requestUrl += "&with_genres=" + with_genres;

        $.ajax({
            method: "GET",
            url: requestUrl,
            dataType: "json"
        }).done(function (data) {
            moviesList = data;
            reBuildGrid(data.results);
        });
    }

    const loadData = (year, genreId) => {
        var requestUrl = "movie/filter" ;
        if (year){ 
        	requestUrl += "?year=" + year;
        	if (genreId) requestUrl += "&genreId=" + genreId;
        } else if (genreId) requestUrl += "?genreId=" + genreId;

        $.ajax({
            method: "GET",
            url: requestUrl,
            dataType: "json"
        }).done(function (data) {
        	console.log(data);
            moviesList = data;
            reBuildGrid(data.results);
        });
    }

    function onInit() {

        $('#applyFilter').on("click", () => { applyFilter(); });
        $('#toggle-gridview').on("click", () => {
            var moviesListComponent = $('#movies-list');
            if (moviesListComponent.hasClass(toggleGridClass)) {
                moviesListComponent.removeClass(toggleGridClass);
                //$('.text-wrapper').each((index, element) => { $(element).removeClass('bg-dark text-white'); });
                $('img').each((index, element) => {
                    const imagePath = $(element).attr('alt');
                    if (imagePath)
                        $(element).attr('src', imagePrefix + imagePath);
                });
            }
            else {
                moviesListComponent.addClass(toggleGridClass);
                $('img').each((index, element) => {
                    const imagePath = $(element).attr('alt');
                    if (imagePath)
                        $(element).attr('src', largeImagePrefix + imagePath);
                });
                //$('.text-wrapper').each((index, element) => { $(element).addClass('bg-dark text-white'); });
            }
        });
    }

    function sortByTitle(a, b, isAsc) {
        if (a.title < b.title) {
            return isAsc ? -1 : 1;
        }
        if (a.title > b.title) {
            return isAsc ? 1 : -1;
        }
        return 0;
    }

    function sortByOnChange(e) {
        let moviesListResults = moviesList;
        switch (e.value) {
            case 'title.asc':
                moviesListResults.sort((a, b) => { return sortByTitle(a, b, true); });
                break;

            case 'title.desc':
                moviesListResults.sort((a, b) => { return sortByTitle(a, b, false); });
                break;
            case 'popularity.asc':
                moviesListResults.sort(function (a, b) { return a.popularity - b.popularity; });
                break;
            case 'popularity.desc':
                moviesListResults.sort(function (a, b) { return a.popularity - b.popularity > 0 ? -1 : 1; });
                break;
            case 'vote_average.asc':
                moviesListResults.sort(function (a, b) { return a.vote_average - b.vote_average; });
                break;
            case 'vote_average.desc':
                moviesListResults.sort(function (a, b) { return a.vote_average - b.vote_average > 0 ? -1 : 1; });
                break;
            case 'release_date.asc':
                moviesListResults.sort(function (a, b) { return 
                	a.release_date? new Date(a.release_date) - new Date(b.release_date) :
                		new Date(a.releasedate) - new Date(b.releasedate); });
                break;
            case 'release_date.desc':
                moviesListResults.sort(function (a, b) { 
                	if(a.release_date){
                		return new Date(a.release_date) - new Date(b.release_date) > 0 ? -1 : 1;                				
                	}
                			
                	return new Date(a.releasedate) - new Date(b.releasedate) > 0 ? -1 : 1; });
                break;

        }
        reBuildGrid(moviesListResults);
    }

    function reBuildGrid(moviesListResults) {
        $('#movies-list').html('');
        $.each(moviesListResults, function (index, item) {
            try {
                if (item) {
                    $('#movies-list').append(createNewListItem(item));
                }
            }
            catch (error) {
                console.log(error);
            }
        });
        $('#movies-list').show();
    }

    Date.prototype.formatMMDDYYYY = function(){
        return (this.getMonth() + 1) + 
        "/" +  this.getDate() +
        "/" +  this.getFullYear();
    }
    
    function createNewListItem(item) {
    	item.release_dateString = item.release_date ? item.release_date : new Date(item.releasedate).formatMMDDYYYY();
    	item.release_date = item.release_date ? item.release_date : new Date(item.releasedate);
    	console.log(item.release_dateString);
        const itemTemplate = $('#movie-template').clone();
        itemTemplate.attr('id', 'movie-' + item.id);
        itemTemplate.attr('style', '');
        itemTemplate.find('a').attr('href', '#' + item.id);
        itemTemplate.find('p').text(item.overview);
        itemTemplate.find('h2').text(item.original_title);
        let title = item.title? 'Title: ' + item.title + ' |' : '';
        itemTemplate.find('span').text(title + 'Released:' + item.release_dateString + '| Rating:' +
            item.vote_average + ' | Popularity: ' + item.popularity);
        const itemTemplateImage = itemTemplate.find('img');
        if (item.poster_path) {
            itemTemplateImage.attr('src', imagePrefix + item.poster_path);
            itemTemplateImage.attr('alt', item.poster_path);
        } else if (item.backdrop_path) {
            itemTemplateImage.attr('src', imagePrefix + item.backdrop_path);
            itemTemplateImage.attr('alt', item.backdrop_path);
        }
        else
            itemTemplate.find('img').hide();
        console.log(item);
        console.log(itemTemplate.find('button[id="deleteMovieBtn"]'));
        if(item.movie_maker && me == item.movie_maker.id){
        	itemTemplate.find('button[id="editMovieBtn"]').click(function(){
        		alert(item.title);
        		editMovie(item.id, item.title, item.release_date, item.poster_path,
        				item.overview, item.popularity, item.genre.id, item.vote_average);        		
            });
        	
        	itemTemplate.find('button[id="deleteMovieBtn"]').click(function(){
        		alert(item.title);
        		deleteMovie(item.id, item.title);
            });
        }else{
        	itemTemplate.find('button[id="editMovieBtn"]').hide();        	
        	itemTemplate.find('button[id="deleteMovieBtn"]').hide();
        }
        
        return itemTemplate;
    }

    function editMovie (id, title, releaseDate, image, overview,
    		popularity, genreId, vote) {
    	console.log(genreId);
    	$('#editMovieId').val(id);
    	$('#title').val(title);			 
		$('#releaseDate').val(formatDate(releaseDate));
		$('#image').val(image);
		$('#overview').val(overview);
		$('#popularity').val(popularity);
		$('#genre_id').val(genreId);//.eq(genreId).prop('selected', true);
	    $('#vote_average').val(vote);  
	    
	    $('#movie-form-container').show();
    	$('#gridView').hide();
	}
    
    function formatDate(date) {    	 
    	var day = ("0" + date.getDate()).slice(-2);
    	var month = ("0" + (date.getMonth() + 1)).slice(-2);
    	var result = date.getFullYear()+"-"+(month)+"-"+(day) ;

    	return result;
    }
    
    function deleteMovie(id, title){  
    	if (confirm("Confirm deleting ' + title +' movie!") == true) {        	
    		$.ajax({            			
    			url: "movie/delete",            			
    			method: "DELETE",            			
    			data: {
        				id:id            			
    			},            			
    			success: function(data){
    				console.log(data);
    				switch(data.status){
        				case 200:
        					reBuildGrid(moviesList);  
        				 	break;            				
        				
        				case 401:                				
            				window.location.href = "index.html";        				
            				break;
            				
            			case 404:
            				alert("There is no such movie!");
            				break;  
            				
        				 default:        					 
        					 alert('Server error!');
        					 break;            				
    				}            			
    			},            			
    			fail: function(){            				
    				alert('Server error!');            			
    			}            		
    		});
    	}
    }

    function applyFilter() {
        const year = $('#filter-year').val();
        const genreId = $('#filter-genre').val();
        
        if (year || genreId) {
            loadData(year, genreId);
        }
    }
    

</script>
</body>

</html>
